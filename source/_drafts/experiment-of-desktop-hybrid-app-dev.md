title: 开发桌面Hybrid App的一点体验
date: 2015-12-30 13:38:54
tags:
---
​前阵子和基友[@licstar](http://weibo.com/licstar)一起做了一个玩具叫[MP3CutAd](https://www.zhihu.com/question/22913899/answer/71352036)，顾名思义它就是用来去除MP3（主要是有声读物）里面的广告的。

![](http://ww2.sinaimg.cn/large/64f14afcgw1extsmje3p3j20m80gon0d.jpg)

如果你是个Web开发者，眼睛稍微尖一点就能看出了，这个程序是一个Hybrid App，为了调用[@licstar](http://weibo.com/licstar)用C#写的API，我用CefSharp（也就是Chromium）做了一个壳，里面承载一个Web App。

<!-- more -->

### 先说说Hybrid

这种方式和我几年前做的一个项目非常相似，时过境迁，区别可以说四个字：鸟枪换炮。

当时我们的壳是IE的，非常不方便调试，于是和客户端一起废了不小的力气，把所有的异步接口都改成HTTP接口。牺牲一些运行时的效率，但是换来了很大的帮助：可以在浏览器里开发了！只需客户端把接口从壳里剥离出来做成一个单独可以运行的HTTP服务。

这样一来开发的效率高了很多，前端可以用Chrome来开发和调试JS业务逻辑，用Profiling工具做性能优化，最后再放进壳里，调调样式兼容性啊什么的。值得一提的是，这个项目一开始因为性能问题而不得不推倒重做，最后正是因为可以放进浏览器里运行，可以用IE的开发者工具进行精确的Profiling，最后做到了90%的场景响应速度达到竞品（使用Webkit壳）的水平，如果只能在壳里开发，这个事情在那么短的时间里基本不敢想。

而几年过后，又能更进一步提高效率。

首先，Cef本身就是Chromium，可以直接在壳里使用dev tools了，更方便了。
其次，我用了Vue来做UI，Vue有良好的组件化实践方式，有数据绑定，这很适合一个桌面程序的开发模式。
另外，我用了webpack的vue-loader，它可以以Component粒度进行hot reload，也就是说，我在调某个组件的过程中，不仅不需要频繁关闭、开启程序（相当于F5），甚至程序的UI状态都是得以保留的，不需要重新复现一次冗长的操作路径。这个功能我第一次见到应该是在React里吧，很厉害，也许以后的开发都会或多或少往这方面靠。

后来我发现，由于我用C#给JS暴露的接口全都是序列化的，也全是异步的，那意味着即使我没有壳，也可以很简单的Mock出所有的接口，让整个程序更具有可测性（写个玩具，测个卵啊）；或者像之前一样做成HTTP接口，让它可以跑在壳之外。

也许正是因为这些特性，才让React Native被受重视。

### 接着谈谈Vue

#### 关于Vue有几点我非常喜欢

1、vue-loader，可以把HTML/JS/CSS写在一个文件里面，这解决了过去jQuery插件那种JS/CSS/HTML分离比较难管理的问题。对于CSS作用域的问题使用的是Scoped CSS，实际体验感觉还ko以。
2、Vue有一个跟DOM事件很像的事件机制，几乎没有学习成本和思路冲突。这样一来组件的对外接口设计变得非常的轻松：输入用props，输出就用事件，行为就用method——这和浏览器内建的那些标签的模式几乎如出一辙。
3、Vue可以把computed属性和普通属性以几乎没有任何差别的方式混在一起使用，过去用Angular的时候，我用的办法是手工给`$scope`对象`defineProperty`，也不是不行，就是丑一点。另一个问题是Augluar因为`$digest`循环执行多少次是不确定的，于是乎`getter`可能会被执行不确定多次，万一它是有副作用的（OKOK我知道这样做是非常不对的），那岂不是要抓瞎？我个人非常喜欢用getter来拉平M层与VM层，因为这样实现省事儿。

#### 也有几点比较嫌弃

1、定义一个Component的时候，如果它用到其他Component，那么需要显式的声明components数组，我懒，哈哈。所以说Angular的依赖注入虽然问题很多，也倒不失为一个方便。
2、如果Vue的model字段能直接接收一个Promise那会非常棒，这样我就可以把异步获取数据的接口直接赋值到model上面，不再需要写胶水代码了。当然也可以用一些比较取巧的办法，比如像ng-resource那样，在原生对象上悄悄捆绑一个Promise。
3、Vue的sublime text插件在编辑.vue的时候，style部分的染色有一些罢工迹象，时常是白的。另外不得不提一个问题就是，也许可以把三者还是实现为分离文件，但通过某些关系，比如显式`include`、或者目录结构规范直接关联起来，这样单独的JS文件也许会更好的得到IDE支持？比如TypeScript那种强类型auto complete。

### 最后说说其他

#### flex box

由于这次不是IE了，可以安心用`flex`来做布局，简直是跨越了一个时代。毕竟老一套的CSS都是用来做文档排版的，做布局还是太奇技淫巧。通过`flex`不仅可以实现我非常喜欢的`Border Layout`——这个东西是SWT里的吧，C#里它叫Dock，而且也有更多的特性。

当然`flex`也有一些实现不了的，只能说并非银弹，但已经非常棒了。

#### CEF

CEF就是Chromium Embeded Framework，几乎常见的语言都有各自移植，最大的缺点当然就是体积，默认的发布包大概有40多MB，还好它绝大多数模块都是可选的，应该可以精简到20MB。（从某种角度上看，这个体积依然不小……）

对于CEF和nw.js、Electron的区别，可以看看我[上一篇文章](/2015/11/09/developing-webapp-with-csharp/)。

### 源代码

这个程序的UI和算法都是开源的（[GitHub](https://github.com/licstar/MP3CutAd)），如果有兴趣的话可以自己把它跑起来，C#部分使用Visual Studio会自动安装ngut依赖。

其中Web App这部分，直接用浏览器打开也是能运行的，当然，因为缺少Native API Bounding，几乎所有功能都是用不了的。有时间我会考虑把bouding都做一组mock接口，让它在浏览器里面也能跑起来。

算法那部分，思路在GitHub的readme里有简单的描述，